1.	manifest:
      "registry_ds.yaml"
      #+begin_src yaml
        apiVersion: extensions/v1beta1
        kind: DaemonSet
        metadata:
          labels:
            name: registry
          name: registry
          namespace: kube-system
        spec:
          selector:
            matchLabels:
              name: registry
          template:
            metadata:
              labels:
                name: registry
            spec:
              containers:
              - env:
                image: registry:2
                imagePullPolicy: IfNotPresent
                name: registry
                resources: {}
                volumeMounts:
                - mountPath: /var/lib/registry
                  name: store
              hostNetwork: true
              nodeSelector:
                kubernetes.io/hostname: cd-demo-1.localdomain
              volumes:  
              - hostPath:
                  path: /var/lib/registry
                  type: ""
                name: store
        ---
        kind: Service
        apiVersion: v1
        metadata:
          name: registry
          namespace: kube-system
        spec:
          selector:
            name: registry
          ports:
            - port: 5000
              targetPort: 5000
      #+end_src

2.	test if this docker-registry works:
      #+begin_example
        [root@cd-demo-1 pki]# kubectl exec -ti test2-deploy-5d4cf98848-wckvd bash
        bash-4.4# curl -i registry.kube-system.svc.cluster.local:5000/v2/_catalog
        HTTP/1.1 200 OK
        Content-Type: application/json; charset=utf-8
        Docker-Distribution-Api-Version: registry/2.0
        X-Content-Type-Options: nosniff
        Date: Wed, 23 May 2018 09:41:51 GMT
        Content-Length: 20
        
        {"repositories":[]}
        bash-4.4#      
      #+end_example

3.	add this registry as "insecure-registry" to docker:
      "/etc/docker/daemon.json"
      #+begin_src js
        {
          "insecure-registries" : ["registry.kube-system.svc.cluster.local:5000"]
        }      
      #+end_src

4.	add kube-dns ip as DNS server for host network:
      "/etc/resolv.conf"
      #+begin_src conf-unix
        ; generated by /usr/sbin/dhclient-script
        search openstacklocal
        ; tonyaw: add the following line.
        nameserver 10.96.0.10          
        nameserver 135.1.1.110                     
        nameserver 135.2.157.1
        nameserver 135.2.157.3
        nameserver 135.2.157.2      
      #+end_src

5.	restart docker:
      #+begin_src shell-script
        service docker restart      
      #+end_src

6.	if you set proxy for docker, remove it:
      #+begin_src shell-script
        mv /etc/systemd/system/docker.service.d/http_proxy.conf ~tonyaw
        systemctl daemon-reload
        service docker restart      
      #+end_src

7.	try to push image into this local docker-registry:
      #+begin_example
        [root@cd-demo-1 tonyaw]# docker images | grep nginx
        nginx                                                                           latest                                 ae513a47849c        3 weeks ago         109MB
        [root@cd-demo-1 tonyaw]# docker tag nginx:latest registry.kube-system.svc.cluster.local:5000/nginx:tonyaw
        [root@cd-demo-1 tonyaw]# docker images | grep nginx
        nginx                                                                           latest                                 ae513a47849c        3 weeks ago         109MB
        registry.kube-system.svc.cluster.local:5000/nginx                               tonyaw                                 ae513a47849c        3 weeks ago         109MB
        [root@cd-demo-1 tonyaw]# docker push registry.kube-system.svc.cluster.local:5000/nginx:tonyaw
        The push refers to repository [registry.kube-system.svc.cluster.local:5000/nginx]
        7ab428981537: Pushed
        82b81d779f83: Pushed
        d626a8ad97a1: Pushed
        tonyaw: digest: sha256:e4f0474a75c510f40b37b6b7dc2516241ffa8bde5a442bde3d372c9519c84d90 size: 948
        [root@cd-demo-1 tonyaw]#      
      #+end_example

8.	try to pull image from this local docker-registry:
      #+begin_example
        [root@cd-demo-1-slave pki]# docker pull registry.kube-system.svc.cluster.local:5000/nginx:tonyaw
        tonyaw: Pulling from nginx
        f2aa67a397c4: Pull complete
        3c091c23e29d: Pull complete
        4a99993b8636: Pull complete
        Digest: sha256:e4f0474a75c510f40b37b6b7dc2516241ffa8bde5a442bde3d372c9519c84d90
        Status: Downloaded newer image for registry.kube-system.svc.cluster.local:5000/nginx:tonyaw
        [root@cd-demo-1-slave pki]#      
      #+end_example

